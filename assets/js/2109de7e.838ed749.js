"use strict";(self.webpackChunkevo_lua_github_io=self.webpackChunkevo_lua_github_io||[]).push([[5059],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=u(a),p=r,m=h["".concat(s,".").concat(p)]||h[p]||d[p]||i;return a?n.createElement(m,o(o({ref:t},c),{},{components:a})):n.createElement(m,o({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:r,o[1]=l;for(var u=2;u<i;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},1129:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var n=a(7462),r=(a(7294),a(3905));const i={sidebar_position:400},o="Exploring the Evo.lua API",l={unversionedId:"getting-started/layered-architecture",id:"getting-started/layered-architecture",title:"Exploring the Evo.lua API",description:"A quick intro to the Lua libraries and FFI bindings",source:"@site/docs/getting-started/layered-architecture.md",sourceDirName:"getting-started",slug:"/getting-started/layered-architecture",permalink:"/docs/getting-started/layered-architecture",draft:!1,editUrl:"https://github.com/evo-lua/evo-lua.github.io/edit/main/docs/getting-started/layered-architecture.md",tags:[],version:"current",sidebarPosition:400,frontMatter:{sidebar_position:400},sidebar:"tutorialSidebar",previous:{title:"Overview: Core Concepts",permalink:"/docs/getting-started/core-concepts"},next:{title:"How-to Guides",permalink:"/docs/category/how-to-guides"}},s={},u=[{value:"Nonstandard Libraries",id:"nonstandard-libraries",level:2},{value:"Layered Architecture",id:"layered-architecture",level:2},{value:"Phenomenal Cosmic Powers",id:"phenomenal-cosmic-powers",level:2},{value:"Examples",id:"examples",level:2},{value:"File System Access",id:"file-system-access",level:3},{value:"Network Programming",id:"network-programming",level:3},{value:"WebViews",id:"webviews",level:3},{value:"Summary",id:"summary",level:2}],c={toc:u},h="wrapper";function d(e){let{components:t,...i}=e;return(0,r.kt)(h,(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"exploring-the-evolua-api"},"Exploring the Evo.lua API"),(0,r.kt)("p",null,"A quick intro to the Lua libraries and FFI bindings"),(0,r.kt)("h2",{id:"nonstandard-libraries"},"Nonstandard Libraries"),(0,r.kt)("p",null,"When using a standard Lua (or LuaJIT) interpreter, the selection of modules that can be used is somewhat limited. This is one of the major issues Evo seeks to solve, by shipping with a much larger number of third-party libraries as well as additional builtin modules. All of these are available to any script run by the interpreter's CLI, so you might want to know what kind of apps you can build with them."),(0,r.kt)("p",null,"While browsing the ",(0,r.kt)("a",{parentName:"p",href:"/docs/category/api"},"API documentation")," should give you a general idea, read the following sections if you want to learn about a few of the most important libraries and why some of them might look like they're doing the same things slightly differently. You'll see there's a very good reason for that, but in order to truly understand why we must take a brief look at how Evo actually works behind the scenes."),(0,r.kt)("h2",{id:"layered-architecture"},"Layered Architecture"),(0,r.kt)("p",null,"The most important thing to remember is this: ",(0,r.kt)("strong",{parentName:"p"},"Evo consists of multiple API layers, which add conveniences on top of each other"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"At the lowest level, a C++ program is running the Lua interpreter and controls the application lifecycle"),(0,r.kt)("li",{parentName:"ul"},"At the highest level, you invoke the command line to run your code, which calls into the lower layers"),(0,r.kt)("li",{parentName:"ul"},"In between, there are multiple levels (a bit like an onion - though hopefully they won't make you cry)"),(0,r.kt)("li",{parentName:"ul"},"Evo effectively translates low-level calls to high-level calls, and vice versa, when running any script"),(0,r.kt)("li",{parentName:"ul"},'You yourself get to choose at which layer of the "onion" you want to write your program code')),(0,r.kt)("p",null,"Generally speaking, the more control you need over what your program is doing (including performance-critical operations like memory allocations and buffer copies), the lower the level at which you will be writing your code. With great power comes great responsibility, however, which is why beginners may want to start at the highest levels first. Evo's APIs are designed such that you can easily move between the highest and the lowest layer as needed, to hopefully find the level of abstraction that works best for your project."),(0,r.kt)("h2",{id:"phenomenal-cosmic-powers"},"Phenomenal Cosmic Powers"),(0,r.kt)("p",null,"Your app gets to make a trade-off between convenience and power by selecting which APIs to call into. You can of course mix and match these calls however you see fit, though there's not often a reason to work at the lower levels when you're just starting out."),(0,r.kt)("p",null,"Like with any trade-off, making the right decision involves knowing the benefits and drawbacks. And here they are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"At the highest level, you can easily perform standard tasks (like building a self-contained executable) using just the command line"),(0,r.kt)("li",{parentName:"ul"},"Beneath that are the namespaced APIs and nonstandard Lua libraries, which are optimized for convenience and common use cases"),(0,r.kt)("li",{parentName:"ul"},"For less frequent use cases or doing things in a slightly unusual way, you may need to use the embedded Lua C-API bindings"),(0,r.kt)("li",{parentName:"ul"},"The lowest layers available from Lua may or may not require manual memory management and careful parameter checking"),(0,r.kt)("li",{parentName:"ul"},"Here, you'll definitely want some experience with the ",(0,r.kt)("a",{parentName:"li",href:"https://luajit.org/ext_ffi_tutorial.html"},"Foreign Function Interface")," and ",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Struct_(C_programming_language)"},"C structs"),", or ",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Segmentation_fault"},"unhappiness will surely find you"))),(0,r.kt)("p",null,"Beneath that, your app won't usually go directly as it would involve modifying the runtime's code itself (",(0,r.kt)("a",{parentName:"p",href:"/docs/how-to-guides/building-from-source"},"it's certainly possible, though"),")."),(0,r.kt)("p",null,"If that seems a bit abstract, it may make more sense after the following sections. But first, here's a diagram of those layers:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"layered-architecture.png",src:a(8027).Z,width:"3300",height:"2100"})),(0,r.kt)("p",null,'You can roughly equate the two axes to "Raw power" and "Level of abstraction". Let\'s now consider a few examples to make this clearer.'),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("h3",{id:"file-system-access"},"File System Access"),(0,r.kt)("p",null,"Since accessing files on disk is one of the few things even the Lua standard library supports, there are many ways to do it:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The simplest way is to use the high-level ",(0,r.kt)("a",{parentName:"li",href:"/docs/references/api/namespaces/filesystem"},"C_FileSystem"),' APIs for a "one and done" approach, which is generally not the most efficient'),(0,r.kt)("li",{parentName:"ul"},"You can also try the standard Lua ",(0,r.kt)("a",{parentName:"li",href:"https://www.lua.org/manual/5.1/manual.html#5.7"},"io library"),", which is simple but doesn't support ",(0,r.kt)("a",{parentName:"li",href:"/docs/getting-started/core-concepts#asynchronous-execution-model"},"non-blocking I/O")," (so its use is discouraged in Evo)"),(0,r.kt)("li",{parentName:"ul"},"For asynchronous I/O you currently need to fall back to the ",(0,r.kt)("a",{parentName:"li",href:"/docs/references/api/bindings/uv"},"libuv")," Lua bindings, though they're safe as they don't rely on the FFI"),(0,r.kt)("li",{parentName:"ul"},"If you instead wanted to avoid all buffer copies and work with ",(0,r.kt)("inlineCode",{parentName:"li"},"cdata")," types directly, you'd need to head into the C++ layer")),(0,r.kt)("p",null,"Note that in this case, there isn't actually a way to use the FFI and improve performance by avoiding Lua string copies (...yet).\nTechnically, you can use the FFI with platform-specific APIs, but that's not portable. However, better runtime support for file system I/O is planned."),(0,r.kt)("h3",{id:"network-programming"},"Network Programming"),(0,r.kt)("p",null,"Distributed systems is an area that's usually performance-sensitive, so that it's warranted to consider the lower-level APIs:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The builtin ",(0,r.kt)("inlineCode",{parentName:"li"},"HttpServer")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"WebSocketServer")," modules are relatively easy to use, but they do incur some unavoidable overhead"),(0,r.kt)("li",{parentName:"ul"},"For more fine-grained control, there's two options; the first is using the Lua bindings to libuv and building on top of TCP or UDP"),(0,r.kt)("li",{parentName:"ul"},"However, this is certainly not the fastest approach (and doesn't provide support for HTTP or WS out of the box) - but ",(0,r.kt)("a",{parentName:"li",href:"/docs/references/api/bindings/uws"},"uws")," does!"),(0,r.kt)("li",{parentName:"ul"},"In this case you'd be responsible for handling events, which can be tricky due to technical constraints, ",(0,r.kt)("em",{parentName:"li"},"and")," memory management")),(0,r.kt)("p",null,"Again there is the option to use the FFI, but only with non-portable APIs - which could be made easier with runtime support."),(0,r.kt)("h3",{id:"webviews"},"WebViews"),(0,r.kt)("p",null,"Opening a WebView is one of the more interesting tasks from a technical perspective. There are a few ways to do it in Evo:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The high-level ",(0,r.kt)("a",{parentName:"li",href:"/docs/references/api/namespaces/webview"},"C_WebView")," namespace makes it very easy to just open a browser window, change the URL, or run JavaScript in it"),(0,r.kt)("li",{parentName:"ul"},"However, it doesn't expose all of the underlying ",(0,r.kt)("a",{parentName:"li",href:"/docs/references/api/bindings/webview"},"webview FFI")," bindings, which can give more control over the JavaScript execution"),(0,r.kt)("li",{parentName:"ul"},"In fact, there are some advanced use cases (such as managing multiple windows) that require a combination of ",(0,r.kt)("a",{parentName:"li",href:"/docs/references/api/bindings/glfw"},"glfw")," and webview"),(0,r.kt)("li",{parentName:"ul"},"If you now wanted to control policies or custom URL schemes, you'd have to go into the C++ layer as that isn't exposed to Lua")),(0,r.kt)("p",null,"It's still possible to, say, display a WebView in your own native window, but since it's an uncommon use case this requires more effort."),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"You've seen how the Lua APIs in Evo are layered such that your app can call into it at different levels of abstraction. Hopefully, you now know why parts of the API are tagged with the \"FFI\" label in the documentation (they're low-level and can cause program instability if misused). And after having seen a few examples, you can probably find your way around the API reference to decide which libraries you want to call into, when you should consider making use of the FFI bindings yourself, and what responsibilities that places on your app."))}d.isMDXComponent=!0},8027:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/layered-architecture-9e1f9e1697b6d87f5459017d4e69c6c5.png"}}]);