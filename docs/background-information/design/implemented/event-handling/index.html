<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-background-information/design/implemented/event-handling">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<title data-rh="true">RFC: Event Handling | Evo.lua</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://evo-lua.github.io//docs/background-information/design/implemented/event-handling"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RFC: Event Handling | Evo.lua"><meta data-rh="true" name="description" content="This document details the design goals behind evo&#x27;s event registry."><meta data-rh="true" property="og:description" content="This document details the design goals behind evo&#x27;s event registry."><link data-rh="true" rel="icon" href="/img/caterpillar.png"><link data-rh="true" rel="canonical" href="https://evo-lua.github.io//docs/background-information/design/implemented/event-handling"><link data-rh="true" rel="alternate" href="https://evo-lua.github.io//docs/background-information/design/implemented/event-handling" hreflang="en"><link data-rh="true" rel="alternate" href="https://evo-lua.github.io//docs/background-information/design/implemented/event-handling" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bb6eaaeb.css">
<link rel="preload" href="/assets/js/runtime~main.216b8304.js" as="script">
<link rel="preload" href="/assets/js/main.cf9a5da6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/caterpillar.png" alt="Evo.lua Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/caterpillar.png" alt="Evo.lua Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Evo.lua</b></a><a class="navbar__item navbar__link" href="/docs">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/evo-lua" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Documentation Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/how-to-guides">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/background-information/">Background Information</a><button aria-label="Toggle the collapsible sidebar category &#x27;Background Information&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/design-documents">Design Documents</a><button aria-label="Toggle the collapsible sidebar category &#x27;Design Documents&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/drafts">Drafts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Drafts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/implemented">Implemented</a><button aria-label="Toggle the collapsible sidebar category &#x27;Implemented&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/implemented/build-system-rework">RFC: Ninja-based Builds</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/background-information/design/implemented/event-handling">RFC: Event Handling</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/background-information/design/template">Template</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/background-information/"><span itemprop="name">Background Information</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/design-documents"><span itemprop="name">Design Documents</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/implemented"><span itemprop="name">Implemented</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RFC: Event Handling</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>RFC: Event Handling</h1><p>This document details the design goals behind evo&#x27;s event registry.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">â€‹</a></h2><p>Asynchronous as well as synchronous events should be handled in a standardized and recognizable fashion.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-decisions">Design Decisions<a class="hash-link" href="#design-decisions" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-registry-vs-event-emitters">Event Registry vs. Event Emitters<a class="hash-link" href="#event-registry-vs-event-emitters" title="Direct link to heading">â€‹</a></h3><p>Events can be handled with a global event registry (&quot;event bus&quot; pattern), or locally (&quot;event emitter&quot; pattern).</p><p>Implications of using a global event registry:</p><ul><li>A global API namespace must be provided (neutral)</li><li>Every event emitter needs to hook into the registry (mild inconvenience)</li><li>All events that fire can be observed and handled from anywhere (maximum flexibility)</li><li>Can easily log events or otherwise track them, without missing any</li></ul><p>Implications of sticking to local event emitters instead:</p><ul><li>Each event emitter must handle its own events (neutral)</li><li>Events are not observable to unrelated code (less flexible)</li><li>Shared functionality needs to be outsourced to a mixin, or inherited (added complexity)</li></ul><p>A global event registry seems like it would be more flexible, simpler to implement, and easier to understand.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-names">Event Names<a class="hash-link" href="#event-names" title="Direct link to heading">â€‹</a></h3><p>Events are always written in capital letters, like <code>APPLICATION_SHUTDOWN</code> (C enum style). The Node.js style of lower-case single-word event names (e.g.,  <code>shutdown</code>) seems less flexible and readable in comparison.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-listeners">Event Listeners<a class="hash-link" href="#event-listeners" title="Direct link to heading">â€‹</a></h3><p>All event handlers should have a standard name and signature, and adhere to the following conventions.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-onevent-catchall-handler">The OnEvent Catchall Handler<a class="hash-link" href="#the-onevent-catchall-handler" title="Direct link to heading">â€‹</a></h4><p>The primary event handler is always <code>OnEvent(eventID, payload)</code> , where <code>payload</code> is a table that contains the named keys and values of all passed arguments. This <code>payload</code> table should <em>not</em> be an array, as that would defeat the point of making it easier to change the signature without having to update existing code that&#x27;s unaffected by the changes.</p><p>This handler serves as a catchall, forwarding events to more specialized handlers. Ideally, it needn&#x27;t be overridden.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="standard-event-handlers">Standard Event Handlers<a class="hash-link" href="#standard-event-handlers" title="Direct link to heading">â€‹</a></h4><p>For each event, the name of its default handler is identical to the event ID written in PascalCase, with underscores removed and the word <code>On</code> preprended. Default event handlers may exist for only a subset of all possible event triggers.</p><p>Example: The <code>APPLICATION_SHUTDOWN</code> event is forwarded to  <code>MyObject:OnApplicationShutdown()</code> by the catchall handler <code>MyObject:OnEvent()</code>, with all arguments intact (this is assuming that <code>MyObject</code> registered for the event first).</p><p>These handlers are designed under the assumption that users won&#x27;t generally override them, although it is possible.</p><p>Example: <code>TcpClient.OnClientReadError</code> will call <code>TcpClient.CLIENT_READ_ERROR</code> and then disconnect the peer.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="placeholder-event-handlers">Placeholder Event Handlers<a class="hash-link" href="#placeholder-event-handlers" title="Direct link to heading">â€‹</a></h4><p>Events that have no implementation in the runtime, but might be of interest to consumers of the API, trigger empty placeholder event handlers. These are effectively no-ops that are intended to be overridden as needed. They always map 1:1 to the event name itself, in all capital letters and without the <code>On</code> prefix used by standard event listeners.</p><p>Example: <code>TcpClient.TCP_SESSION_ENDED</code>  is called whenever <code>TCP_SESSION_ENDED</code> fires, but it does nothing by default</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="optional-payloads">Optional Payloads<a class="hash-link" href="#optional-payloads" title="Direct link to heading">â€‹</a></h4><p>Creating new <code>payload</code> tables doesn&#x27;t seem to add any overhead, <a href="https://gist.github.com/Duckwhale/5685a0abe2930d563b4bc931a543b536" target="_blank" rel="noopener noreferrer">according to some very basic benchmarking</a>.</p><p>Since accessing the <code>payload</code> table <em>does</em> have a measurable performance impact, and many event handlers will only care about the <code>eventID</code> itself, it doesn&#x27;t make sense to only pass a <code>payload</code> table with a <code>payload.eventID</code> field that would have to be read every time. When no arguments are passed, there&#x27;s also no table creation (possible <a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)" target="_blank" rel="noopener noreferrer">GC churn</a>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-sharing">Code Sharing<a class="hash-link" href="#code-sharing" title="Direct link to heading">â€‹</a></h3><p>With a standardized approach to event handling, the core functionality can be outsourced to a <a href="https://en.wikipedia.org/wiki/Mixin" target="_blank" rel="noopener noreferrer">mixin</a>. This is preferable to direct inheritance as it removes the need for metatable lookups. These can be costly and aren&#x27;t always well-optimized by the runtime. It also improves transparency because all methods are copied to the target, though this comes at the cost of some redundancy and leads to slightly higher memory usage per object. As Lua(JIT) generally has a low memory footprint, the trade-off is probably worth it, though some benchmarking would have to be done first.</p><p><a href="https://gist.github.com/Duckwhale/d3116b5c92f44c82b48ad3f2955b277b" target="_blank" rel="noopener noreferrer">Initial benchmarking</a> suggests there may not be any difference in performance, at least in simple cases that can easily be optimized. However, having every object inherit from a single ancestor will lead to bloated hierarchies (see NodeJS) and doesn&#x27;t play well with objects that already use metatables for other purposes, or are inherited from another object. For that reason, the initial version should simply use a mixin; this can always be re-evaluated later if the need arises.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="historical-context">Historical Context<a class="hash-link" href="#historical-context" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="capitalized-event-names">Capitalized Event Names<a class="hash-link" href="#capitalized-event-names" title="Direct link to heading">â€‹</a></h3><p>Event emitters in NodeJS are generally less readable than they could be (like most JavaScript code...). Therefore, a more flexible naming scheme that supports adding information without sacrificing readability should be adopted. Since event names are effectively constants (i.e., enum values), capitalizing them only seems consistent with established C/Lua programming practice. It also allows a clear separation between user-implemented and standard event handlers.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="network-messages-and-events">Network Messages and Events<a class="hash-link" href="#network-messages-and-events" title="Direct link to heading">â€‹</a></h3><p>Messages received from a remote peer can trigger events directly, and messages to be sent can trivially be constructed from events. This is (presumably) what happens in the World of Warcraft client, and also in NodeJS, which indicates that the model fits well with a networked application such as a server based on libuv. Hence both NodeJS and the WOW API are referenced herein as case studies, with the goal of finding a design that hopefully improves on their weaknesses.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="variable-number-of-arguments">Variable Number of Arguments<a class="hash-link" href="#variable-number-of-arguments" title="Direct link to heading">â€‹</a></h3><p>In the original WOW API, event handlers would pass multiple values via varargs, like <code>OnEvent(eventID, ...)</code>. This has proven to cause issues when signatures inevitably have to change, which is why arguments should be passed as a <code>payload</code> table. Entries should be indexed with the argument name, so that accessing missing fields raise a script error, and no changes need to be made to legacy code when new ones are added or unused properties are removed.</p><p>Events are objects in JavaScript as well, which may however be due to the lack of varargs in early versions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="technical-constraints">Technical Constraints<a class="hash-link" href="#technical-constraints" title="Direct link to heading">â€‹</a></h2><p>Because libuv provides the underlying event loop and it works with callbacks for asynchronous events, any implementation built on top of it can at best mask this fact. Event handlers then are merely callback functions in disguise, providing a slightly higher-level interface that can more easily be adapted to the problem domain.</p><p>The performance of handling large numbers of events will always be dictated by the overhead of Lua-C interactions (libuv callbacks), and by how well the underlying LuaJIT runtime manages to optimize a particular use case. There&#x27;s no way around this short of writing C code directly, which is undesirable. This overhead is likely insignificant in many cases.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternatives">Alternatives<a class="hash-link" href="#alternatives" title="Direct link to heading">â€‹</a></h2><p>None, except using libuv callbacks exclusively. This results in somewhat unidiomatic Lua code, akin to JS. Not ideal.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">â€‹</a></h2><ul><li><a href="https://nodejs.org/api/events.html" target="_blank" rel="noopener noreferrer">Events in Node.js</a> (uses local event emitters)</li><li><a href="https://wowpedia.fandom.com/wiki/Events" target="_blank" rel="noopener noreferrer">Events in the World of Warcraft client</a> (uses a global event registry bound to local objects)</li><li>The <a href="http://docs.libuv.org/en/v1.x/design.html" target="_blank" rel="noopener noreferrer">libuv event loop</a> will be the facilitator of callback-induced events</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/background-information/design/implemented/event-handling.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/background-information/design/implemented/build-system-rework"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RFC: Ninja-based Builds</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/background-information/design/template"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Template</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#design-decisions" class="table-of-contents__link toc-highlight">Design Decisions</a><ul><li><a href="#event-registry-vs-event-emitters" class="table-of-contents__link toc-highlight">Event Registry vs. Event Emitters</a></li><li><a href="#event-names" class="table-of-contents__link toc-highlight">Event Names</a></li><li><a href="#event-listeners" class="table-of-contents__link toc-highlight">Event Listeners</a></li><li><a href="#code-sharing" class="table-of-contents__link toc-highlight">Code Sharing</a></li></ul></li><li><a href="#historical-context" class="table-of-contents__link toc-highlight">Historical Context</a><ul><li><a href="#capitalized-event-names" class="table-of-contents__link toc-highlight">Capitalized Event Names</a></li><li><a href="#network-messages-and-events" class="table-of-contents__link toc-highlight">Network Messages and Events</a></li><li><a href="#variable-number-of-arguments" class="table-of-contents__link toc-highlight">Variable Number of Arguments</a></li></ul></li><li><a href="#technical-constraints" class="table-of-contents__link toc-highlight">Technical Constraints</a></li><li><a href="#alternatives" class="table-of-contents__link toc-highlight">Alternatives</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Evo.lua project (authors and contributors).</div></div></div></footer></div>
<script src="/assets/js/runtime~main.216b8304.js"></script>
<script src="/assets/js/main.cf9a5da6.js"></script>
</body>
</html>