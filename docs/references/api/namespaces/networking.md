# C_Networking

High-level networking interface for HTTP and WebSocket servers

## Status

<Experimental/>

## Availability

The individual modules in this  namespace are preloaded and can be accessed directly:

```lua
local HttpServer = require("HttpServer")
```

## UUID

Unique identifiers internally refer to each connection (WebSocket client or HTTP request). They're Lua strings in a standard [RFC](https://en.wikipedia.org/wiki/Universally_unique_identifier) format, as generated by the builtin [uuid](/docs/references/api/libraries/uuid) (and [stduuid](/docs/references/api/bindings/stduuid)) libraries. You shouldn't rely on their format however, and treat them as opaque handles.

## WebServerMessage

This is the message format used by the internal WebServer implementation. Lua event handlers receive it as the `payload` data:

* `eventTypeID` is the `enum` value used by the WebServer to identify the type of event (you can probably just ignore it entirely)
* `clientID` is a unique identifier for the request (or client), which may or may not have become invalid by the time you see the event
* `message` is a buffer containing the payload data in an event-specific format (encoded as a `string` value)

You'll have to make sure the message payload is interpreted correctly based on the event that you wish to handle, and check that the request or client identified by the `clientID` is still valid when you actually process the event (as the other end might have disconncted).

<Struct name="WebServerMessage">
<Member name="eventTypeID" type="number"/>
<Member name="clientID" type="UUID"/>
<Member name="message" type="string"/>
</Struct>

## HttpServer

### Events

##### ASYNC_POLLING_UPDATE

Triggers after the runtime has finished polling the WebServer for updates and processing all deferred (buffered) events.

##### HTTP_CONNECTION_ABORTED

Triggered when a HTTP connection was dropped by the connected peer. UUID handles will always be invalid when this happens.

<Function>
<Parameters>
<Parameter name="event" type="string"/>
<Parameter name="payload" type="WebServerMessage"/>
</Parameters>
</Function>

##### HTTP_CONNECTION_WRITABLE

Triggered when a HTTP connection that you have streamed data to (via [StreamResponse](#streamresponse)) can accept more data.

The message buffer contains the `offset` (`number` value, starting at `0`) of the first byte that you should send again.

<Function>
<Parameters>
<Parameter name="event" type="string"/>
<Parameter name="payload" type="WebServerMessage"/>
</Parameters>
</Function>

##### HTTP_DATA_RECEIVED

Triggered when a HTTP connection receives an intermittent data chunk (see [Chunked Transfer Encoding](https://en.wikipedia.org/wiki/Chunked_transfer_encoding)). Expect additional chunks.

The message buffer contains the received chunk.

##### HTTP_REQUEST_FINISHED

Triggered when a HTTP connection receives the final data chunk (see [Chunked Transfer Encoding](https://en.wikipedia.org/wiki/Chunked_transfer_encoding)). There are no more remaining chunks.

The message buffer contains the received chunk.

<Function>
<Parameters>
<Parameter name="event" type="string"/>
<Parameter name="payload" type="WebServerMessage"/>
</Parameters>
</Function>

##### HTTP_REQUEST_STARTED

Triggered when a HTTP request has been received (at least) up until the end of the [headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers) section. The message may or may not have been received completely, but this is when the UUID handle first becomes valid (for the lifetime of the connection only).

<Function>
<Parameters>
<Parameter name="event" type="string"/>
<Parameter name="payload" type="WebServerMessage"/>
</Parameters>
</Function>

##### UNKNOWN_OR_INVALID_WEBSERVER_EVENT

Indicates an error in the internal WebServer which hasn't been properly handled by the runtime. Please open an issue if that happens.

##### SERVER_STARTED_LISTENING

Triggered when the WebServer is accepting connections. The message buffer contains the port number (encoded as a `string` value).

<Function>
<Parameters>
<Parameter name="event" type="string"/>
<Parameter name="payload" type="WebServerMessage"/>
</Parameters>
</Function>

##### SERVER_STOPPED_LISTENING

Triggered when the WebServer has shut down. The message buffer contains `"Going Away"` if it was a planned shutdown ([StopListening](#stoplistening)).

<Function>
<Parameters>
<Parameter name="event" type="string"/>
<Parameter name="payload" type="WebServerMessage"/>
</Parameters>
</Function>

### Fields

#### DEFAULT_PORT

The default port that should be used when none has been specified.

### Functions

#### AddRoute

Registers a new HTTP route for the given method. Routes may include wildcards. They're resolved in order of specificity.

<Function>
<Parameters>
<Parameter name="route" type="string"/>
<Parameter name="httpMethod" type="string" fallback="ANY" optional/>
</Parameters>
</Function>

#### GetRegisteredRoutes

Returns the internal routing table for the given method. Each entry in this table contains a list of registered route patterns in the order that they have been added (via [AddRoute](#addroute)).  This list is purely for bookkeeping and you should never modify the result directly.

<Function>
<Parameters>
<Parameter name="httpMethod" type="string"/>
</Parameters>
<Returns>
<Return name="registeredRoutes" type="RoutingTable"/>
</Returns>
</Function>

<Struct name="RoutingTable">
<Member name="GET" type="table"/>
<Member name="POST" type="table"/>
<Member name="OPTIONS" type="table"/>
<Member name="DELETE" type="table"/>
<Member name="PATCH" type="table"/>
<Member name="PUT" type="table"/>
<Member name="HEAD" type="table"/>
<Member name="ANY" type="table"/>
</Struct>

#### GetRequestDetails
#### GetRequestEndpoint
#### GetRequestHeader
#### GetRequestHeaders
#### GetRequestMethod
#### GetRequestQuery
#### GetRequestURL
#### HasRequestDetails

#### ProcessDeferredEvents

Explicitly poll the internal WebServer for new events. This will generally happen automatically with some predefined frequency.

#### StartListening

Starts listening for new HTTP connections on the given port.

<Function>
<Parameters>
<Parameter name="port" type="number" fallback="DEFAULT_PORT" optional/>
</Parameters>
</Function>

#### StopListening

Stops listening for new HTTP connections and shuts down the server. Any pending requests will be cancelled immediately.

#### SendResponse
#### StreamResponse
#### WriteHeader
#### WriteResponse
#### WriteStatus

## WebSocketServer

### Events

#### ASYNC_POLLING_UPDATE
#### SERVER_STARTED_LISTENING
#### SERVER_STOPPED_LISTENING
#### UNKNOWN_OR_INVALID_WEBSERVER_EVENT
#### WEBSOCKET_CONNECTION_CLOSED
#### WEBSOCKET_CONNECTION_ESTABLISHED
#### WEBSOCKET_MESSAGE_RECEIVED

### Fields

#### DEFAULT_PORT

The default port that should be used when none has been specified.

### Functions

#### BroadcastBinaryMessage
#### BroadcastCompressedTextMessage
#### BroadcastTextMessage
#### GetNumConnectedClients

#### ProcessDeferredEvents

Explicitly poll the internal WebServer for new events. This will generally happen automatically with some predefined frequency.

#### SendBinaryMessageToClient
#### SendCompressedTextMessageToClient
#### SendTextMessageToClient

#### SetEchoMode

Toggles echo server mode. Useful only for debugging or protocol compliance testing.

In echo server mode, each incoming WebSocket message will be returned as-is to the client.

<Function>
<Parameters>
<Parameter name="enabledFlag" type="boolean"/>
</Parameters>
</Function>

#### StartListening

Starts listening for new WebSocket connections on the given port.

<Function>
<Parameters>
<Parameter name="port" type="number" fallback="DEFAULT_PORT" optional/>
</Parameters>
</Function>

#### StopListening

Stops listening for new WebSocket connections and shuts down the server. All clients will be disconnected immediately.

## Changelog

| Version |      What happened?       |
| :-----: | :-----------------------: |
| v0.0.1  |      Initial release      |
